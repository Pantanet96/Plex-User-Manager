version: '3.8'

services:
  plex-manager:
    build: .
    container_name: plex-user-manager
    restart: unless-stopped
    
    ports:
      - "${SERVER_PORT:-5000}:${SERVER_PORT:-5000}"
    
    environment:
      # Flask Configuration
      - FLASK_APP=app.py
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      
      # Server Configuration
      - SERVER_PORT=${SERVER_PORT:-5000}
      - HTTPS_ENABLED=${HTTPS_ENABLED:-false}
      
      # Plex Configuration (optional - can be set via UI)
      - PLEX_URL=${PLEX_URL:-}
      - PLEX_TOKEN=${PLEX_TOKEN:-}
      
      # Scheduler Configuration (optional - can be set via UI)
      - SCHEDULER_TYPE=${SCHEDULER_TYPE:-interval}
      - SCHEDULER_INTERVAL_MINUTES=${SCHEDULER_INTERVAL_MINUTES:-60}
      - SCHEDULER_DAILY_TIME=${SCHEDULER_DAILY_TIME:-03:00}
      
      # Database Configuration
      - DATABASE_PATH=/app/instance/plex_manager.db
      
      # Timezone
      - TZ=${TZ:-Europe/Rome}
    
    volumes:
      # Persistent database
      - ./data/instance:/app/instance
      
      # Persistent SSL certificates
      - ./data/certs:/app/certs
      
      # Persistent logs
      - ./data/logs:/app/logs
      
      # Optional: Custom SSL certificates (if using custom certs)
      # - ./custom-certs:/app/custom-certs:ro
    
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:${SERVER_PORT:-5000}').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Optional: Resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

# Optional: Create a network for better isolation
# networks:
#   plex-network:
#     driver: bridge
